//!
//! \file skl_guid
//!
//! \license Licensed under the MIT License. See LICENSE for details.
//!
#pragma once

#include "skl_buffer_view"
#include "skl_pair"

namespace skl {
//! Size of a GUID in bytes
constexpr byte CGUIDSize = 16u;

//! Raw guid byte array
using GUID_raw_t = byte[CGUIDSize];

//! Raw guid byte array
using GUID_u64_t = u64[2u];

//! Simple, 16 random bytes guid
//! \remark Default constructs to the null-guid (16 zero bytes)
struct alignas(8u) GUID {
    static constexpr byte CSize = CGUIDSize;

    //Default construct as null-guid
    constexpr GUID() noexcept = default;

    //! Construct from low and high u64 parts
    constexpr GUID(u64 f_low, u64 f_high) noexcept
        : m_low{f_low}
        , m_high{f_high} {
    }

    //! Construct from raw byte array
    constexpr GUID(const GUID_raw_t f_raw) noexcept
        : m_low{static_cast<u64>(f_raw[0])
                | static_cast<u64>(f_raw[1]) << 8u
                | static_cast<u64>(f_raw[2]) << 16u
                | static_cast<u64>(f_raw[3]) << 24u
                | static_cast<u64>(f_raw[4]) << 32u
                | static_cast<u64>(f_raw[5]) << 40u
                | static_cast<u64>(f_raw[6]) << 48u
                | static_cast<u64>(f_raw[7]) << 56u}
        , m_high{static_cast<u64>(f_raw[8])
                 | static_cast<u64>(f_raw[9]) << 8u
                 | static_cast<u64>(f_raw[10]) << 16u
                 | static_cast<u64>(f_raw[11]) << 24u
                 | static_cast<u64>(f_raw[12]) << 32u
                 | static_cast<u64>(f_raw[13]) << 40u
                 | static_cast<u64>(f_raw[14]) << 48u
                 | static_cast<u64>(f_raw[15]) << 56u} {
    }

    //! Construct with specific bytes
    constexpr GUID(byte f_b0,
                   byte f_b1,
                   byte f_b2,
                   byte f_b3,
                   byte f_b4,
                   byte f_b5,
                   byte f_b6,
                   byte f_b7,
                   byte f_b8,
                   byte f_b9,
                   byte f_b10,
                   byte f_b11,
                   byte f_b12,
                   byte f_b13,
                   byte f_b14,
                   byte f_b15) noexcept
        : m_low{static_cast<u64>(f_b0)
                | static_cast<u64>(f_b1) << 8u
                | static_cast<u64>(f_b2) << 16u
                | static_cast<u64>(f_b3) << 24u
                | static_cast<u64>(f_b4) << 32u
                | static_cast<u64>(f_b5) << 40u
                | static_cast<u64>(f_b6) << 48u
                | static_cast<u64>(f_b7) << 56u}
        , m_high{static_cast<u64>(f_b8)
                 | static_cast<u64>(f_b9) << 8u
                 | static_cast<u64>(f_b10) << 16u
                 | static_cast<u64>(f_b11) << 24u
                 | static_cast<u64>(f_b12) << 32u
                 | static_cast<u64>(f_b13) << 40u
                 | static_cast<u64>(f_b14) << 48u
                 | static_cast<u64>(f_b15) << 56u} {
    }

    constexpr GUID(const GUID&) noexcept            = default;
    constexpr GUID& operator=(const GUID&) noexcept = default;
    constexpr GUID(GUID&&) noexcept                 = default;
    constexpr GUID& operator=(GUID&&) noexcept      = default;
    constexpr ~GUID() noexcept                      = default;

    [[nodiscard]] constexpr pair<u64, u64> raw() const noexcept {
        return {m_low, m_high};
    }

    [[nodiscard]] constexpr bool operator==(const GUID& f_other) const noexcept {
        return m_low == f_other.m_low && m_high == f_other.m_high;
    }

    [[nodiscard]] constexpr bool is_null() const noexcept {
        return (m_low | m_high) == 0u;
    }

    void to_string(skl_buffer_view f_target_buffer) const noexcept;

private:
    u64 m_low{0u};
    u64 m_high{0u};
};

//! [LibInit][ThreadLocal] Make new guid
[[nodiscard]] GUID make_guid() noexcept;

//! [LibInit][ThreadLocal] Make new guid
//! \remark Faster, less "collision-safe"
[[nodiscard]] GUID make_guid_fast() noexcept;

//! Make new guid
//! \remark Creates new instance of SklRand on each call
[[nodiscard]] GUID g_make_guid() noexcept;

//! Make new guid
//! \remark Creates new instance of SklRand on each call
//! \remark Faster, less "collision-safe"
[[nodiscard]] GUID g_make_guid_fast() noexcept;
} // namespace skl

namespace skl {
//! Null GUID
constexpr GUID GUID_Zero{};

//! Max GUID
constexpr GUID GUID_Max{0xffffffffffffffffull, 0xffffffffffffffffull};

struct guid_hash {
    [[nodiscard]] static u64 operator()(const skl::GUID& f_guid) noexcept {
        const auto [lo, hi] = f_guid.raw();
        return lo ^ hi;
    }
};
} // namespace skl
