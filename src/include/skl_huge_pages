//!
//! \file skl_huge_pages
//!
//! \brief Linux 2MB huge pages allocation support for x86_64
//!
//! \note x86_64 Linux only, requires Clang, C++23
//! \note Call skl_huge_pages_init() before using allocation functions
//!
#pragma once

#include "skl_int"

namespace skl::huge_pages {
    //! [Const] Standard huge page size on x86_64 Linux (2MB)
    constexpr u64 CHugePageSize = (2ull * 1024ull * 1024ull);

    //! [Init] Initialize huge pages subsystem
    //!
    //! \returns True if huge pages are available, false otherwise
    //!
    //! \remark Must be called before using any allocation functions
    //! \remark Tests huge page availability by attempting a test allocation
    //! \remark Sets internal global flag used by is_huge_pages_enabled()
    [[nodiscard]] bool skl_huge_pages_init() noexcept;

    //! [Getter] Check if huge pages are enabled
    //!
    //! \returns True if skl_huge_pages_init() succeeded
    //!
    //! \remark Returns the cached result from initialization
    [[nodiscard]] bool is_huge_pages_enabled() noexcept;

    //! [Allocator] [LibInit] Allocate sequential 2MB huge pages
    //!
    //! \param f_page_count Number of 2MB pages to allocate
    //! \returns Pointer to allocated memory (2MB-aligned), nullptr on failure
    //!
    //! \remark Asserts that huge pages are available (must call skl_huge_pages_init() first)
    //! \remark Allocates f_page_count * 2MB bytes
    //! \remark Memory is automatically 2MB-aligned by the kernel
    //! \remark Pages are pinned immediately to force physical memory allocation
    //! \remark Allocated memory must be freed with skl_huge_page_free()
    [[nodiscard]] void* skl_huge_page_alloc(u64 f_page_count) noexcept;

    //! [Allocator] Free memory allocated with skl_huge_page_alloc
    //!
    //! \param f_ptr Pointer to memory allocated with skl_huge_page_alloc
    //! \param f_page_count Number of 2MB pages to free (must match allocation)
    //!
    //! \remark f_page_count must match the count used in skl_huge_page_alloc
    //! \remark Uses munmap to free the memory
    void skl_huge_page_free(void* f_ptr, u64 f_page_count) noexcept;

    //! [Util] Get the system page size
    //!
    //! \returns System page size in bytes (typically 4096)
    [[nodiscard]] u64 get_system_page_size() noexcept;

    //! [Util] Calculate how many 2MB pages are needed for a byte size
    //!
    //! \param f_bytes Size in bytes
    //! \returns Number of 2MB huge pages needed (rounded up)
    [[nodiscard]] constexpr u64 bytes_to_page_count(u64 f_bytes) noexcept {
        return (f_bytes + (CHugePageSize - 1u)) / CHugePageSize;
    }

    //! [Util] Calculate byte size from page count
    //!
    //! \param f_page_count Number of 2MB pages
    //! \returns Total bytes (f_page_count * 2MB)
    [[nodiscard]] constexpr u64 page_count_to_bytes(u64 f_page_count) noexcept {
        return f_page_count * CHugePageSize;
    }
} // namespace skl::huge_pages

